<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>List Tidy</title>

<style>
body {
  font-family: "Segoe UI", Arial, sans-serif;
  padding: 30px;
  background: #f5f7fa;
}
.container {
  max-width: 1000px;
  margin: auto;
  background: #fff;
  padding: 24px;
  border-radius: 12px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.08);
}
h1 {
  margin-bottom: 16px;
}
input, button {
  padding: 8px 12px;
  margin-right: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
}
button {
  cursor: pointer;
  background: #2ecc71;
  color: #fff;
  border: none;
  font-weight: 600;
}
button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
#output {
  margin-top: 20px;
  padding: 12px;
  border: none;
  border-radius: 0;
  overflow-x: auto;
}
#output table {
  border-collapse: collapse;
  width: 100%;
  font-family: "Segoe UI", Arial, sans-serif;
  font-size: 14px;
  table-layout: auto;
}
#output th, #output td {
  border: 1px solid #ddd;
  padding: 8px 12px;
  text-align: left;
  vertical-align: top;
  white-space: normal;
  word-break: break-word;
}
#output th {
  background: #f0f4f8;
  font-weight: 700;
}
#output tr:nth-child(even) td {
  background: #fafafa;
}
#output th:nth-child(1), #output td:nth-child(1) { min-width: 40px; max-width: 50px; }
#output th:nth-child(2), #output td:nth-child(2) { max-width: 350px; width: auto; }
#output th:nth-child(3), #output td:nth-child(3) { min-width: 30px; }
#output th:nth-child(4), #output td:nth-child(4) { min-width: 40px; }
#output th:nth-child(5), #output td:nth-child(5) { min-width: 10px; max-width: 20px; }
#output th:nth-child(6), #output td:nth-child(6) { min-width: 200px; max-width: 250px; }
#output td { min-height: 36px; }
#output td:empty::after { content: "\00a0"; }
#output tbody tr:last-child td { border-bottom: 1px solid #ddd; }
td[contenteditable="true"] { background-color: #fffbe6 !important; outline: none; }
td[contenteditable="true"]:focus { background-color: #fff2b2 !important; }
@media print {
  @page { size: landscape; margin: 15mm; }
  body { background: #fff; padding: 0; font-family: "Segoe UI", Arial, sans-serif; font-size: 14px; }
  .container { box-shadow: none; max-width: 100%; padding: 0; }
  #output { margin: 0; padding: 0; }
  #output table { border-collapse: collapse; width: 100%; table-layout: fixed; }
  #output th, #output td { border: 1px solid #ddd; padding: 8px 12px; text-align: left; vertical-align: top; word-break: break-word; }
  #output th { background: #666 !important; color: #fff !important; font-weight: 700; }
  #output tr:nth-child(even) td { background: #fafafa; }
  #output th:nth-child(1), #output td:nth-child(1) { width: 8%; }
  #output th:nth-child(2), #output td:nth-child(2) { width: 33%; }
  #output th:nth-child(3), #output td:nth-child(3) { width: 5%; }
  #output th:nth-child(4), #output td:nth-child(4) { width: 10%; }
  #output th:nth-child(5), #output td:nth-child(5) { width: 4%; }
  #output th:nth-child(6), #output td:nth-child(6) { width: 40%; }
  #output td { min-height: 50px; }
  #output tr { page-break-inside: avoid; }
  input, button, h1 { display: none !important; }
  td[contenteditable="true"] { background-color: transparent !important; }
}
</style>
</head>

</head>
<body>
<div class="container">
  <h1>List Tidy</h1>
  <input type="file" id="fileInput" accept=".csv">
  <button id="downloadBtn" disabled>Download Excel</button>
  <button id="printBtn" disabled>Print</button>
  <div id="output"></div>
</div>

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script>
let tidyData = [];

function parseCSV(text){
  return text.trim().split(/\r?\n/).map(line=>line.split(","));
}

function escapeHtml(s){
  return String(s).replace(/[&<>]/g, ch => ({"&":"&amp;","<":"&lt;",">":"&gt;"}[ch]));
}

function renderTable(rows){
  if(!rows.length) return "<p>No data</p>";
  let html = "<table><thead><tr>" +
			 rows[0].map(h=>`<th>${escapeHtml(h)}</th>`).join("") +
			 "</tr></thead><tbody>";
  for(let i=1;i<rows.length;i++){
	html += "<tr>" + rows[i].map(c=>`<td>${escapeHtml(c??"")}</td>`).join("") + "</tr>";
  }
  html += "</tbody></table>";
  return html;
}

function parseDateDDMMMYY(str, centuryBase=1900){
  if(!str) return null;
  const m = str.trim().match(/^(\d{1,2})-([A-Za-z]{3})-(\d{2})$/);
  if(!m) return null;
  const [_, d, mon, yy] = m;
  const months = {jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};
  const month = months[mon.toLowerCase()];
  if(month===undefined) return null;
  let year = centuryBase + parseInt(yy,10);
  const currentYear = new Date().getFullYear();
  if(currentYear - year > 120) year += 100;
  return new Date(year, month, parseInt(d,10));
}

function calculateAge(dobStr){
  const dob = parseDateDDMMMYY(dobStr,1900);
  if(!dob || isNaN(dob.getTime())) return "";
  const today = new Date();
  let age = today.getFullYear() - dob.getFullYear();
  if(today.getMonth()<dob.getMonth() || (today.getMonth()===dob.getMonth() && today.getDate()<dob.getDate())) age--;
  return age>=0 ? age : "";
}

function tidyFromRows(rows){
  if(rows.length<2) return [["NHI","Name","Age","Ward","Day","Notes"]];
  const headers = rows[0].map(h=>h.trim());
  const idx = {
	nhi: headers.indexOf("NHI"),
	surname: headers.indexOf("Surname"),
	given: headers.indexOf("Given Name"),
	dob: headers.indexOf("Date Of Birth"),
	sex: headers.indexOf("Sex"),
	admit: headers.indexOf("Admit Date"),
	ward: headers.indexOf("Ward / Bed")
  };
  const today = new Date();
  const out = [["NHI","Name","Age","Ward","Day","Notes"]];

  for(let i=1;i<rows.length;i++){
	const r = rows[i];
	if(!r || r.length<headers.length) continue;
	if(r.every(cell=>!cell||!cell.trim())) continue;
	if(!r[idx.surname]?.trim() || !r[idx.given]?.trim() || !r[idx.dob]?.trim() || !r[idx.admit]?.trim() || !r[idx.nhi]?.trim()) continue;

	const name = `${r[idx.surname].trim()}, ${r[idx.given].trim()}`;
	const ageVal = calculateAge(r[idx.dob]);
	const sexLetter = r[idx.sex]?.trim().charAt(0).toUpperCase()||"";
	const age = ageVal!=="" ? `${ageVal} ${sexLetter}` : "";

	const admitDate = parseDateDDMMMYY(r[idx.admit],2000);
	const day = (admitDate instanceof Date && !isNaN(admitDate.getTime()))
	  ? Math.floor((today - admitDate)/(1000*60*60*24))
	  : "";

	const outputRow = [r[idx.nhi], name, age, r[idx.ward]?.trim()||"", day, ""];
	if(outputRow.slice(1).every(cell=>cell==="")) continue;
	out.push(outputRow);
  }

  const header = out[0];
  const body = out.slice(1).sort((a,b)=>{
	const key=w=>(w?.startsWith("IC1")?"0":w?.startsWith("ED")?"1":"2")+(w||"");
	return key(a[3]).localeCompare(key(b[3]));
  });
  return [header,...body];
}

function renderTable(rows){
  if(!rows.length) return "<p>No data</p>";
  let html = "<table><thead><tr>" + 
             rows[0].map(h=>`<th>${escapeHtml(h)}</th>`).join("") + 
             "</tr></thead><tbody>";

  for(let i=1;i<rows.length;i++){
    html += "<tr>";
    rows[i].forEach((c, j) => {
      if(j === rows[0].length - 1) {
        // Notes column = last column
        html += `<td contenteditable="true" data-row="${i}" data-col="${j}">${escapeHtml(c ?? "")}</td>`;
      } else {
        html += `<td>${escapeHtml(c ?? "")}</td>`;
      }
    });
    html += "</tr>";
  }

  html += "</tbody></table>"; 
  return html;
}

document.getElementById("output").addEventListener("input", e => {
  const cell = e.target;
  if(cell.tagName === "TD" && cell.hasAttribute("contenteditable")) {
    const row = parseInt(cell.dataset.row, 10);
    const col = parseInt(cell.dataset.col, 10);
    tidyData[row][col] = cell.innerText.trim();
  }
});


document.getElementById("fileInput").addEventListener("change", e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ev=>{
	let rows = parseCSV(ev.target.result);
	rows = rows.filter(r=>r.some(cell=>cell!=null && cell.toString().trim()!==""));
	tidyData = tidyFromRows(rows);
	document.getElementById("output").innerHTML = renderTable(tidyData);
	document.getElementById("downloadBtn").disabled = tidyData.length<2;
	document.getElementById("printBtn").disabled = tidyData.length<2;
  };
  reader.readAsText(file);
});

document.getElementById("downloadBtn").addEventListener("click", () => {
  if (!tidyData.length) return;

  const wb = XLSX.utils.book_new();

  // Create a sheet starting with the header row
  const ws = XLSX.utils.aoa_to_sheet([tidyData[0]]);

  // Style the header row
  tidyData[0].forEach((_, cIdx) => {
    const cellRef = XLSX.utils.encode_cell({ r: 0, c: cIdx });
    ws[cellRef].s = {
      font: { bold: true, color: { rgb: "FFFFFFFF" }, name: "Segoe UI", sz: 11 },
      fill: { fgColor: { rgb: "FF666666" } },
      alignment: { horizontal: "center", vertical: "center", wrapText: true },
      border: {
        top: { style: "thin", color: { rgb: "FF000000" } },
        bottom: { style: "thin", color: { rgb: "FF000000" } },
        left: { style: "thin", color: { rgb: "FF000000" } },
        right: { style: "thin", color: { rgb: "FF000000" } }
      }
    };
  });

  // Add the rest of the data rows
  for (let i = 1; i < tidyData.length; i++) {
    XLSX.utils.sheet_add_aoa(ws, [tidyData[i]], { origin: -1 });

    // Adjust Notes row height based on approximate character count
    const notesText = tidyData[i][5] || '';
    const approxLines = Math.ceil(notesText.length / 60);
    if (!ws['!rows']) ws['!rows'] = [];
    ws['!rows'][i] = { hpt: Math.max(15, approxLines * 15) };
  }

  // Set column widths
  ws["!cols"] = [
    { wch: 12 }, // NHI
    { wch: 22 }, // Name
    { wch: 8 },  // Age
    { wch: 8 },  // Ward
    { wch: 6 },  // Day
    { wch: 65 }  // Notes
  ];

  XLSX.utils.book_append_sheet(wb, ws, "Tidy Data");
  XLSX.writeFile(wb, "Inpatient Search tidied.xlsx", { bookType: "xlsx", cellStyles: true });
});

document.getElementById("printBtn").addEventListener("click", ()=>{
  if(tidyData.length < 2) return;
  window.print();
});
</script>
</body>
</html>
